<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creativity & Code</title>
    
    <!-- Import Map for ES Modules -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "react": "https://aistudiocdn.com/react@^19.2.0"
      }
    }
    </script>
    
    <!-- Babel for in-browser transpilation of TSX/JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Configure Tailwind CSS
      tailwind.config = {
        darkMode: 'class', // Enables toggling dark mode via a class on the html element
        theme: {
          extend: {
            fontFamily: {
              'default': ['"Helvetica Neue"', 'Helvetica', 'Arial', 'sans-serif'],
              'dyslexia-friendly': ['OpenDyslexic', 'Arial', 'sans-serif'],
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- Font for Dyslexia-Friendly Mode -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/opendyslexic@0.1.2/build/opendyslexic.min.css">
    
    <style>
      /* Simple global styles to prevent content overflow issues */
      body {
        overscroll-behavior-y: contain;
      }
    </style>
</head>
<body>
    <!-- The root element for the React application -->
    <div id="root"></div>
    
    <!-- Dynamic Module Loader -->
    <script type="module">
      const transpiledModules = new Map();

      async function loadModule(path) {
        // 1. Check cache
        if (transpiledModules.has(path)) {
          return transpiledModules.get(path);
        }

        // 2. Fetch source code
        const response = await fetch(path);
        if (!response.ok) throw new Error(`Failed to fetch ${path}: ${response.statusText}`);
        let sourceCode = await response.text();

        // 3. Find dependencies
        const dependencyRegex = /from\s+['"]((?:\.\/|\.\.\/).*?(\.tsx|\.ts))['"]/g;
        const dependencies = [];
        let match;
        while ((match = dependencyRegex.exec(sourceCode))) {
          dependencies.push(match[1]);
        }

        // 4. Recursively load and resolve dependencies
        const resolvedDeps = await Promise.all(
          dependencies.map(async (depPath) => {
            const absoluteDepUrl = new URL(depPath, path).href;
            const blobUrl = await loadModule(absoluteDepUrl);
            return { originalPath: depPath, blobUrl };
          })
        );

        // 5. Rewrite import paths in the source code to use Blob URLs
        for (const dep of resolvedDeps) {
          const regex = new RegExp(`from\\s+['"]${dep.originalPath}['"]`, 'g');
          sourceCode = sourceCode.replace(regex, `from "${dep.blobUrl}"`);
        }

        // 6. Transpile the rewritten code using Babel
        const transpiled = Babel.transform(sourceCode, {
          presets: ["react", "typescript"],
          filename: path, // Important for better error messages
        }).code;

        // 7. Create a Blob and an Object URL for the transpiled JS
        const blob = new Blob([transpiled], { type: 'application/javascript' });
        const blobUrl = URL.createObjectURL(blob);

        // 8. Cache and return the Blob URL
        transpiledModules.set(path, blobUrl);
        return blobUrl;
      }

      // Entry point for the application
      (async () => {
        try {
          const entryPointUrl = new URL('index.tsx', window.location.href).href;
          const appUrl = await loadModule(entryPointUrl);
          // Dynamically import the final, fully-resolved module
          import(appUrl);
        } catch (error) {
          console.error("Error loading application:", error);
          const root = document.getElementById('root');
          if (root) {
            root.innerHTML = `<div style="padding: 2rem; font-family: sans-serif; color: #ff3333; background-color: #1a0000; border-radius: 8px;">
                <h2 style="font-size: 1.5rem;">Application failed to load</h2>
                <p style="margin-top: 1rem;">Could not fetch or transpile the source files. Please check the browser console for more details.</p>
                <pre style="margin-top: 1rem; padding: 1rem; background-color: #330000; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">${error.message}</pre>
            </div>`;
          }
        }
      })();
    </script>
</body>
</html>